<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Spoilage Detection Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fff;
        }

        h1 {
            margin-top: 20px;
            text-align: center;
            margin: 20px;
        }

        .status {
            margin: 10px 20px;
            font-size: 1.2em;
            text-align: center;
        }

        .status span {
            font-weight: bold;
        }

        .status .running {
            color: green;
        }

        .status .offline {
            color: red;
        }

        .current-values {
            margin: 20px 20px;
            font-size: 1.2em;
            text-align: center;
        }

        .chart-container {
            width: 80%;
            margin: 20px 0;
        }

        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            font-size: 17px;
        }

        .toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @-webkit-keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @-webkit-keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        @media (max-width: 600px) {
            .status {
                word-wrap: break-word;
            }
        }
    </style>
</head>

<body>
    <h1>Food Spoilage Detection Dashboard</h1>
    <div class="status" id="systemStatus">
        Status: <span class="offline">OFFLINE</span>
    </div>
    <div class="current-values" id="currentValues">
        Loading current values...
    </div>
    <div class="chart-container">
        <canvas id="temperatureChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="humidityChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="mq4VoltageChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="mq135VoltageChart"></canvas>
    </div>

    <div id="toast" class="toast">Made with love, by group 12 (Liu, Li, Muhammad and Ash)</div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCW-G6tFz3GuJUiyJXEwhvaDtZJUKpHQgY",
            authDomain: "cits5506-project-6a953.firebaseapp.com",
            projectId: "cits5506-project-6a953",
            storageBucket: "cits5506-project-6a953.appspot.com",
            messagingSenderId: "77710866748",
            appId: "1:77710866748:web:83afd2ac6efd41a79c0639"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        // Chart.js setup
        var temperatureCtx = document.getElementById('temperatureChart').getContext('2d');
        var humidityCtx = document.getElementById('humidityChart').getContext('2d');
        var mq4VoltageCtx = document.getElementById('mq4VoltageChart').getContext('2d');
        var mq135VoltageCtx = document.getElementById('mq135VoltageChart').getContext('2d');

        var temperatureChart = new Chart(temperatureCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperature (°C)',
                    data: [],
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        var humidityChart = new Chart(humidityCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Humidity (%)',
                    data: [],
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        var mq4VoltageChart = new Chart(mq4VoltageCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'MQ4 Voltage (V)',
                    data: [],
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        var mq135VoltageChart = new Chart(mq135VoltageCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'MQ135 Voltage (V)',
                    data: [],
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Fetch data from Firestore and update charts
        function fetchData() {
            const twelveHoursAgo = new Date(Date.now() - 12 * 60 * 60 * 1000);

            db.collection('readings').where('timestamp', '>=', twelveHoursAgo).orderBy('timestamp').get().then(snapshot => {
                // Clear existing data
                temperatureChart.data.labels = [];
                temperatureChart.data.datasets[0].data = [];
                humidityChart.data.labels = [];
                humidityChart.data.datasets[0].data = [];
                mq4VoltageChart.data.labels = [];
                mq4VoltageChart.data.datasets[0].data = [];
                mq135VoltageChart.data.labels = [];
                mq135VoltageChart.data.datasets[0].data = [];

                snapshot.forEach(doc => {
                    var data = doc.data();
                    var timestamp = data.timestamp.toDate();

                    // Update temperature chart
                    temperatureChart.data.labels.push(timestamp);
                    temperatureChart.data.datasets[0].data.push(data.temperature);

                    // Update humidity chart
                    humidityChart.data.labels.push(timestamp);
                    humidityChart.data.datasets[0].data.push(data.humidity);

                    // Update MQ4 voltage chart
                    mq4VoltageChart.data.labels.push(timestamp);
                    mq4VoltageChart.data.datasets[0].data.push(data.mq4_voltage);

                    // Update MQ135 voltage chart
                    mq135VoltageChart.data.labels.push(timestamp);
                    mq135VoltageChart.data.datasets[0].data.push(data.mq135_voltage);
                });

                // Update charts
                temperatureChart.update();
                humidityChart.update();
                mq4VoltageChart.update();
                mq135VoltageChart.update();
            });
        }

        // Fetch current values from Firestore and update the display
        function fetchCurrentValues() {
            db.collection('readings').orderBy('timestamp', 'desc').limit(1).onSnapshot(snapshot => {
                snapshot.forEach(doc => {
                    var data = doc.data();
                    document.getElementById('currentValues').innerText = `Temperature: ${data.temperature.toFixed(1)}℃, Humidity: ${data.humidity.toFixed(1)}%, MQ4 Voltage: ${data.mq4_voltage.toFixed(3)}V, MQ135 Voltage: ${data.mq135_voltage.toFixed(3)}V`;

                    // Update system status
                    const now = new Date();
                    const lastTimestamp = data.timestamp.toDate();
                    const diffSeconds = Math.floor((now - lastTimestamp) / 1000);

                    if (diffSeconds <= 10) {
                        document.getElementById('systemStatus').innerHTML = 'Status: <span class="running">RUNNING</span>';
                    } else {
                        document.getElementById('systemStatus').innerHTML = `Status: <span class="offline">OFFLINE</span><br>(last seen ${diffSeconds} seconds ago)`;
                    }
                });
            });
        }

        // Show toast popup
        function showToast() {
            var toast = document.getElementById("toast");
            toast.className = "toast show";
            setTimeout(function () { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // Start fetching data
        fetchCurrentValues();
        fetchData();
        setInterval(fetchData, 30000); // Update charts every 30 seconds
        setInterval(fetchCurrentValues, 1000); // Update current values every second

        // Show toast popup on page load
        window.onload = showToast;
    </script>
</body>

</html>