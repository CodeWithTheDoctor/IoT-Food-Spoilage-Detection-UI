<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Spoilage Detection Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fff;
        }

        h1 {
            margin-top: 20px;
            text-align: center;
            margin: 20px;
        }

        .status {
            margin: 10px 20px;
            font-size: 1.2em;
            text-align: center;
        }

        .status span {
            font-weight: bold;
        }

        .status .running {
            color: green;
        }

        .status .offline {
            color: red;
        }

        .current-values {
            margin: 20px 20px;
            font-size: 1.2em;
            text-align: center;
        }

        .chart-container {
            width: 80%;
            margin: 20px 0;
        }

        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            font-size: 17px;
        }

        .toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @-webkit-keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @-webkit-keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        @media (max-width: 600px) {
            .status {
                word-wrap: break-word;
            }
        }
    </style>
</head>

<body>
    <h1>Food Spoilage Detection Dashboard</h1>
    <div class="status" id="systemStatus">
        Status: <span class="offline">OFFLINE</span>
    </div>
    <div class="current-values" id="currentValues">
        Loading current values...
    </div>
    <div class="chart-container">
        <canvas id="temperatureChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="humidityChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="mq4VoltageChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="mq135VoltageChart"></canvas>
    </div>

    <!-- New Form to Download Data as CSV -->
    <div>
        <form id="downloadForm">
            <label for="hoursInput">Enter number of hours of data:</label>
            <input type="number" id="hoursInput" name="hoursInput" min="1" value="7">
            <button type="submit">Download CSV</button>
        </form>
    </div>

    <div id="toast" class="toast">Made with love, by group 12 (Liu, Li, Muhammad and Ash)</div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB6bDJ8CVYJGSknBtuDPpARfq7FYPWXtNI",
            authDomain: "superchat-a933e.firebaseapp.com",
            projectId: "superchat-a933e",
            storageBucket: "superchat-a933e.appspot.com",
            messagingSenderId: "292696901282",
            appId: "1:292696901282:web:e99fdfb6c880ee157e79fb"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        // Enable Firestore persistence for caching
        firebase.firestore().enablePersistence()
            .catch(function (err) {
                if (err.code === 'failed-precondition') {
                    console.log('Persistence failed - multiple tabs open');
                } else if (err.code === 'unimplemented') {
                    console.log('Persistence not available in this browser');
                }
            });

        // Chart.js setup
        var temperatureCtx = document.getElementById('temperatureChart').getContext('2d');
        var humidityCtx = document.getElementById('humidityChart').getContext('2d');
        var mq4VoltageCtx = document.getElementById('mq4VoltageChart').getContext('2d');
        var mq135VoltageCtx = document.getElementById('mq135VoltageChart').getContext('2d');

        var temperatureChart = new Chart(temperatureCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperature (°C)',
                    data: [],
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        var humidityChart = new Chart(humidityCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Humidity (%)',
                    data: [],
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        var mq4VoltageChart = new Chart(mq4VoltageCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'MQ4 Voltage (V)',
                    data: [],
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        var mq135VoltageChart = new Chart(mq135VoltageCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'MQ135 Voltage (V)',
                    data: [],
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        let latestTimestamp = null;

        // Real-time listener to update chart data from Firestore
        db.collection('readings').orderBy('timestamp', 'desc').limit(1).onSnapshot(snapshot => {
            snapshot.forEach(doc => {
                const latestData = doc.data();
                latestTimestamp = latestData.timestamp.toDate();

                // Now fetch data for the last 7 hours from the latest point received
                const sevenHoursBefore = new Date(latestTimestamp.getTime() - 7 * 60 * 60 * 1000);
                db.collection('readings')
                    .where('timestamp', '>=', sevenHoursBefore)
                    .orderBy('timestamp', 'asc')
                    .get()
                    .then(snapshot => {
                        // Clear existing data
                        temperatureChart.data.labels = [];
                        temperatureChart.data.datasets[0].data = [];
                        humidityChart.data.labels = [];
                        humidityChart.data.datasets[0].data = [];
                        mq4VoltageChart.data.labels = [];
                        mq4VoltageChart.data.datasets[0].data = [];
                        mq135VoltageChart.data.labels = [];
                        mq135VoltageChart.data.datasets[0].data = [];

                        snapshot.forEach(doc => {
                            var data = doc.data();
                            var timestamp = data.timestamp.toDate();

                            // Populate the charts
                            temperatureChart.data.labels.push(timestamp);
                            temperatureChart.data.datasets[0].data.push(data.temperature);
                            humidityChart.data.labels.push(timestamp);
                            humidityChart.data.datasets[0].data.push(data.humidity);
                            mq4VoltageChart.data.labels.push(timestamp);
                            mq4VoltageChart.data.datasets[0].data.push(data.mq4_voltage);
                            mq135VoltageChart.data.labels.push(timestamp);
                            mq135VoltageChart.data.datasets[0].data.push(data.mq135_voltage);
                        });

                        // Update the charts
                        temperatureChart.update();
                        humidityChart.update();
                        mq4VoltageChart.update();
                        mq135VoltageChart.update();
                    });
            });
        });

        // Function to download data in CSV format
        function downloadCSV(hours) {
            const startTime = new Date(latestTimestamp.getTime() - hours * 60 * 60 * 1000);
            db.collection('readings')
                .where('timestamp', '>=', startTime)
                .orderBy('timestamp', 'asc')
                .get()
                .then(snapshot => {
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "timestamp,temperature,humidity,mq4_voltage,mq135_voltage\n";
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const row = `${data.timestamp.toDate().toISOString()},${data.temperature},${data.humidity},${data.mq4_voltage},${data.mq135_voltage}\n`;
                        csvContent += row;
                    });
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `sensor_data_${hours}_hours.csv`);
                    document.body.appendChild(link);
                    link.click();
                });
        }

        // Fetch current values from Firestore and update the display using real-time updates
        function fetchCurrentValuesRealTime() {
            db.collection('readings').orderBy('timestamp', 'desc').limit(1).onSnapshot(snapshot => {
                snapshot.forEach(doc => {
                    var data = doc.data();
                    document.getElementById('currentValues').innerText = `Temperature: ${data.temperature.toFixed(1)}℃, Humidity: ${data.humidity.toFixed(1)}%, MQ4 Voltage: ${data.mq4_voltage.toFixed(3)}V, MQ135 Voltage: ${data.mq135_voltage.toFixed(3)}V`;

                    // Update system status
                    const now = new Date();
                    const lastTimestamp = data.timestamp.toDate();
                    const diffSeconds = Math.floor((now - lastTimestamp) / 1000);

                    if (diffSeconds <= 10) {
                        document.getElementById('systemStatus').innerHTML = 'Status: <span class="running">RUNNING</span>';
                    } else {
                        document.getElementById('systemStatus').innerHTML = `Status: <span class="offline">OFFLINE</span><br>(last seen ${diffSeconds} seconds ago)`;
                    }
                });
            });
        }

        // Handle CSV download on form submit
        document.getElementById('downloadForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const hours = document.getElementById('hoursInput').value;
            downloadCSV(hours);
        });

        // Show toast popup
        function showToast() {
            var toast = document.getElementById("toast");
            toast.className = "toast show";
            setTimeout(function () { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // Start fetching data
        fetchCurrentValuesRealTime(); // Real-time updates for current values

        // Show toast popup on page load
        window.onload = showToast;
    </script>
</body>

</html>